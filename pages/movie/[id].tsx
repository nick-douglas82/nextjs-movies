import Head from 'next/head'
import Image from 'next/image'
import { GetStaticPaths, GetStaticProps } from 'next/types'
import type { ICredits } from '../../types/credits';
import { formatYear } from '../../lib/helpers/date';
import SiteHeader from '../../components/SiteHeader'
import Meta from '../../components/Meta';
import Credits from '../../components/Credits';

export interface MovieData {
  movie: {
    title: string;
    overview: string;
    tagline: string;
    backdrop_path: string;
    poster_path: string;
    vote_average: number;
    runtime: number;
    genres: [{
      id: number;
      name: string;
    }];
    release_date: string;
  },
  credits: ICredits;
}

const Movie = ({ movie, credits }: MovieData) => {
  return (
    <div>
      <Head>
        <title>NextJs Movies</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="mx-auto mt-10 max-w-7xl">
        <SiteHeader />

        <header className="relative w-full overflow-hidden h-96">
          <Image
            src={`https://image.tmdb.org/t/p/original${movie.backdrop_path}`}
            alt=""
            layout="raw"
            width={1920}
            height={720}
            className="absolute inset-0 object-cover"
          />
        </header>

        <div className="flex max-w-5xl mx-auto">
          <div className="relative z-20 flex-shrink-0 -mt-14 w-52">
            <Image
              src={`https://image.tmdb.org/t/p/original${movie.poster_path}`}
              alt=""
              layout="raw"
              width={220}
              height={330}
            />
            <div className="flex items-end justify-center mt-3 text-xl">
              <span className="mr-1 text-4xl font-bold tracking-tighter">
                {movie.vote_average}
              </span>
              <span className="relative -top-0.5">/</span>
              <span className="ml-1">10</span>
            </div>
          </div>
          <div className="w-full mt-8 ml-24">
            <header>
              <div className="flex items-end">
                <h1 className="text-3xl font-bold tracking-tighter text-center">{movie.title}</h1>
                <div className="relative ml-1 tracking-tighter text-center -top-0.5 text-1xl">({formatYear(movie.release_date)})</div>
              </div>
              <h3 className="font-bold text-gray-500">{movie.tagline}</h3>
            </header>
            <Meta item={movie} />
            <div className="mt-4 text-gray-600">{movie.overview}</div>

            <Credits credits={credits} />
          </div>
        </div>
      </main>
    </div>
  )
}

export const getStaticPaths: GetStaticPaths = async () => {
  return {
    paths: [],
    fallback: 'blocking'
  }
}

export const getStaticProps: GetStaticProps = async (context) => {
  const id = context?.params?.id;

  let [movieData, creditsData] = await Promise.all([
    fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=e0c577647a14eae09f07aa14fee7caeb`),
    fetch(`https://api.themoviedb.org/3/movie/${id}/credits?api_key=e0c577647a14eae09f07aa14fee7caeb`)
  ]);

  const [movie, credits] = await Promise.all([movieData.json(), creditsData.json()]);
  return {
    props: {
      movie,
      credits
    },
  };
};

export default Movie